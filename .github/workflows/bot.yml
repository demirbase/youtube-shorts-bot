# .github/workflows/bot.yml
# This is the GitHub Actions workflow that runs the bot on a schedule.

name: Reddit-to-YouTube-Shorts-Bot

on:
  # Allows manual triggering from the GitHub Actions tab
  workflow_dispatch:
  
  # Runs on a CRON schedule: every 6 hours (at 0, 6, 12, 18 UTC)
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    # CRITICAL: This permission is required to allow the action
    # to push the updated used_posts.txt back to the repo.
    permissions:
      contents: write

    steps:
      - name: 1. Check out repository
        uses: actions/checkout@v4
        with:
          # We need a full history to diff and push
          fetch-depth: 0

      - name: 2. Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # Cache dependencies

      - name: 3. Set up FFmpeg
        # Installs the FFmpeg binary into the runner environment
        # Uses a well-regarded community action
        uses: AnimMouse/setup-ffmpeg@v1

      - name: 4. Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 5. Load Secrets into Environment
        # This step securely loads GitHub secrets and makes them
        # available as environment variables for the main.py script.
        # Using proper heredoc syntax with environment variables
        env:
          CLIENT_SECRETS: ${{ secrets.CLIENT_SECRETS }}
          YOUTUBE_TOKEN: ${{ secrets.YOUTUBE_TOKEN }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
          REDDIT_PASSWORD: ${{ secrets.REDDIT_PASSWORD }}
        run: |
          {
            echo "CLIENT_SECRETS_CONTENT<<EOF"
            echo "$CLIENT_SECRETS"
            echo "EOF"
            echo "YOUTUBE_TOKEN_CONTENT<<EOF"
            echo "$YOUTUBE_TOKEN"
            echo "EOF"
            echo "REDDIT_CLIENT_ID<<EOF"
            echo "$REDDIT_CLIENT_ID"
            echo "EOF"
            echo "REDDIT_CLIENT_SECRET<<EOF"
            echo "$REDDIT_CLIENT_SECRET"
            echo "EOF"
            echo "REDDIT_USERNAME<<EOF"
            echo "$REDDIT_USERNAME"
            echo "EOF"
            echo "REDDIT_PASSWORD<<EOF"
            echo "$REDDIT_PASSWORD"
            echo "EOF"
          } >> $GITHUB_ENV

      - name: 6. Run the Python Bot
        # This executes the main orchestration script.
        # main.py will read the env vars set in the previous step.
        run: |
          python main.py

      - name: 7. Commit and Push State File
        # This block saves the 'used_posts.txt' file back to the repo,
        # ensuring the bot does not reuse posts.
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions-bot@github.com'
          
          # Stage the state file
          git add used_posts.txt
          
          # Check if there are changes to commit
          # This prevents empty commits if no new posts were found
          if git diff --staged --quiet; then
            echo "No new posts used. No commit necessary."
          else
            git commit -m "AUTOBOT: Update used_posts.txt"
            echo "Committing updated used_posts.txt"
            git push
            echo "State file pushed to repository."
          fi

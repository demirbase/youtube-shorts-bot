# .github/workflows/bot.yml
# This is the GitHub Actions workflow that runs the bot on a schedule.

name: Reddit-to-YouTube-Shorts-Bot

on:
  # Allows manual triggering from the GitHub Actions tab
  workflow_dispatch:
  
  # CRON schedule DISABLED - Run manually only
  # Uncomment the lines below to re-enable automatic runs every 6 hours
  # schedule:
  #   - cron: '0 */6 * * *'

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    # CRITICAL: This permission is required to allow the action
    # to push the updated used_posts.txt back to the repo.
    permissions:
      contents: write

    steps:
      - name: 1. Check out repository
        uses: actions/checkout@v4
        with:
          # We need a full history to diff and push
          fetch-depth: 0

      - name: 2. Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # Cache dependencies

      - name: 3. Set up FFmpeg
        # Installs the FFmpeg binary into the runner environment
        # Uses a well-regarded community action
        uses: AnimMouse/setup-ffmpeg@v1

      - name: 4. Install System Dependencies for Playwright
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libasound2t64

      - name: 5. Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: 6. Install Playwright Browsers
        run: |
          playwright install chromium --with-deps

      - name: 7. Load Secrets into Environment
        # This step securely loads GitHub secrets and makes them
        # available as environment variables for the main.py script.
        # All secrets are passed directly as environment variables to the next step
        # No need to write to $GITHUB_ENV - simpler and more reliable
        env:
          CLIENT_SECRETS_CONTENT: ${{ secrets.CLIENT_SECRETS }}
          YOUTUBE_TOKEN_CONTENT: ${{ secrets.YOUTUBE_TOKEN }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
          REDDIT_PASSWORD: ${{ secrets.REDDIT_PASSWORD }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        run: |
          echo "âœ… Secrets loaded into environment variables"

      - name: 8. Run the Python Bot
        # This executes the main orchestration script.
        # Secrets are passed directly as environment variables
        env:
          CLIENT_SECRETS_CONTENT: ${{ secrets.CLIENT_SECRETS }}
          YOUTUBE_TOKEN_CONTENT: ${{ secrets.YOUTUBE_TOKEN }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
          REDDIT_PASSWORD: ${{ secrets.REDDIT_PASSWORD }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        run: |
          python main.py

      - name: 9. Upload Pending Videos as Artifacts
        # If quota exceeded, upload videos for manual download
        if: always()  # Run even if previous steps failed
        uses: actions/upload-artifact@v4
        with:
          name: pending-videos-${{ github.run_number }}
          path: pending_uploads/
          retention-days: 30  # Keep artifacts for 30 days
          if-no-files-found: ignore  # Don't fail if no videos

      - name: 10. Commit and Push State File
        # This block saves the 'used_posts.txt' file back to the repo,
        # ensuring the bot does not reuse posts.
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions-bot@github.com'
          
          # Stage the state file
          git add used_posts.txt
          
          # Check if there are changes to commit
          # This prevents empty commits if no new posts were found
          if git diff --staged --quiet; then
            echo "No new posts used. No commit necessary."
          else
            git commit -m "AUTOBOT: Update used_posts.txt"
            echo "Committing updated used_posts.txt"
            git push
            echo "State file pushed to repository."
          fi
